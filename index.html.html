<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Infinite Platformer â€” High Score</title>
  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden}
    canvas{display:block;background: skyblue;transition: background 2s linear}
    .overlay{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.7);color:#fff;display:flex;
      flex-direction:column;align-items:center;justify-content:center;z-index:2
    }
    .btn{padding:10px 20px;font-size:18px;margin-top:18px;cursor:pointer}
    input{padding:8px;font-size:16px;margin-top:10px;border-radius:5px;border:none}
    #scoreboard {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: #111; border: 4px solid #444; padding: 10px 20px;
      font-family: monospace; color: #0f0; font-size: 20px; font-weight: bold;
      text-align: center; letter-spacing: 2px; box-shadow: 0 0 12px #000 inset, 0 0 6px #0f0;
      border-radius: 6px; z-index: 3;
    }
    #scoreboard span.label { color: #fff; margin-right: 8px; }
    #carousel{display:flex;gap:12px;margin:14px 0}
    .circle{width:40px;height:40px;border-radius:50%;cursor:pointer;border:3px solid white;transition:transform .18s}
    .circle.selected{transform:scale(1.15);border-color:yellow}
    #highScoreBox { margin-top: 12px; font-size: 18px; color: gold; font-weight: bold; }
  </style>
</head>
<body>

<div id="mainMenu" class="overlay">
  <h1>Infinite Platformer</h1>
  <p>Enter Your Username:</p>
  <input id="usernameInput" type="text" placeholder="Your name" />
  <div id="highScoreBox">High Score: 0</div>
  <p>Select Your Player Color:</p>
  <div id="carousel"></div>
  <button class="btn" onclick="startGame(1)">Level One</button>
  <button class="btn" onclick="startGame(2)">Level Two</button>
  <button class="btn" onclick="startGame(3)">Level Three</button>
</div>

<div id="scoreboard"><span class="label">SCORE</span>0</div>

<div id="gameOver" class="overlay" style="display:none">
  <h1>Game Over</h1>
  <button class="btn" onclick="restartGame()">Replay</button>
  <button class="btn" onclick="goToMenu()">Main Menu</button>
</div>

<div id="winScreen" class="overlay" style="display:none">
  <h1 id="winMessage">You Won!</h1>
  <button class="btn" onclick="restartGame()">Replay</button>
  <button class="btn" onclick="goToMenu()">Main Menu</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let player, platforms, keys, scrollOffset, score, gameRunning, platformCount;
let selectedColor = 'red', username = '', currentLevel = 1;

const gravity = 0.5;
const winningScore = 200;
const playerColors = ['red','blue','green','orange','purple','cyan'];

let highScore = localStorage.getItem("platformerHighScore") || 0;
document.getElementById("highScoreBox").innerText = "High Score: " + highScore;

function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();

/* Rounded rect util */
function drawRoundedRect(ctx,x,y,w,h,r){
  if (typeof r === 'number') r = {tl:r,tr:r,br:r,bl:r};
  ctx.beginPath();
  ctx.moveTo(x + r.tl, y);
  ctx.lineTo(x + w - r.tr, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
  ctx.lineTo(x + w, y + h - r.br);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
  ctx.lineTo(x + r.bl, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
  ctx.lineTo(x, y + r.tl);
  ctx.quadraticCurveTo(x, y, x + r.tl, y);
  ctx.closePath();
}

/* Player */
class Player {
  constructor(){
    this.baseSize = 36;
    this.width = this.baseSize; this.height = this.baseSize;
    this.x = 120; this.y = canvas.height - this.height - 60;
    this.velocityY = 0; this.speed = 5; this.jumpPower = -12;
    this.onGround = false; this.squash = 1; this.stretch = 1;
    this.attachedPlatform = null;
  }
  draw(){
    const cx = this.x + this.width/2, cy = this.y + this.height/2;
    ctx.save(); ctx.translate(cx, cy); ctx.scale(this.stretch, this.squash);
    ctx.fillStyle = selectedColor;
    ctx.beginPath(); ctx.arc(0, 0, this.baseSize/2, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = 'white';
    ctx.beginPath(); ctx.arc(-6, -6, 4, 0, Math.PI*2); ctx.arc(8, -6, 4, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = 'black';
    ctx.beginPath(); ctx.arc(-6, -6, 2, 0, Math.PI*2); ctx.arc(8, -6, 2, 0, Math.PI*2); ctx.fill();
    ctx.restore();
    // feet
    const leftFootX = this.x + this.width*0.28, rightFootX = this.x + this.width*0.72, footY = this.y+this.height+2;
    ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(leftFootX, footY); ctx.lineTo(leftFootX-7, footY+10);
    ctx.moveTo(leftFootX, footY); ctx.lineTo(leftFootX+7, footY+10);
    ctx.moveTo(rightFootX, footY); ctx.lineTo(rightFootX-7, footY+10);
    ctx.moveTo(rightFootX, footY); ctx.lineTo(rightFootX+7, footY+10);
    ctx.stroke();
  }
  update(platforms){
    this.velocityY += gravity;
    let nextY = this.y + this.velocityY;
    const wasOnGround = this.onGround;
    this.onGround = false;
    this.attachedPlatform = null;

    for (let p of platforms){
      if (this.x + this.width > p.x && this.x < p.x + p.width){
        if (this.y + this.height <= p.y && nextY + this.height >= p.y){
          this.velocityY = 0;
          nextY = p.y - this.height;
          this.onGround = true;
          this.attachedPlatform = p; // lock onto platform
        }
      }
    }

    // apply moving platform delta if attached
    if(this.attachedPlatform instanceof MovingPlatform){
      let dx = this.attachedPlatform.x - this.attachedPlatform.lastX;
      let dy = this.attachedPlatform.y - this.attachedPlatform.lastY;
      this.x += dx; nextY += dy;
    }

    this.y = nextY;

    // squash/stretch
    if (!wasOnGround && this.onGround){ this.squash=0.72; this.stretch=1.28; }
    else if (wasOnGround && !this.onGround){ this.squash=1.28; this.stretch=0.72; }
    else { this.squash += (1-this.squash)*0.18; this.stretch += (1-this.stretch)*0.18; }

    this.draw();
  }
}

/* Platform + Moving */
class Platform {
  constructor(x,y,width=120,height=28){ this.x=x; this.y=y; this.width=width; this.height=height; this.coins=[]; }
  draw(){
    const grassHeight=Math.min(12,this.height), mudHeight=Math.max(0,this.height-grassHeight);
    ctx.fillStyle='#6B3E1A'; if(mudHeight>0) ctx.fillRect(this.x,this.y+grassHeight,this.width,mudHeight);
    ctx.fillStyle='#2E8B57'; drawRoundedRect(ctx,this.x,this.y,this.width,grassHeight,8); ctx.fill();
    this.coins.forEach(c=>{c.draw(); c.checkCollect(player);});
  }
}
class MovingPlatform extends Platform {
  constructor(x,y,w,h,type){ super(x,y,w,h); this.type=type; this.baseX=x; this.baseY=y; this.lastX=x; this.lastY=y; }
  update(){
    this.lastX=this.x; this.lastY=this.y;
    const t=Date.now()/600;
    if(this.type==='vertical') this.y=this.baseY+Math.sin(t)*40;
    if(this.type==='horizontal') this.x=this.baseX+Math.sin(t)*80;
    const dx=this.x-this.lastX, dy=this.y-this.lastY;
    this.coins.forEach(c=>{c.x+=dx; c.y+=dy;});
  }
  draw(){ this.update(); super.draw(); }
}

/* Coin */
class Coin {
  constructor(x,y){ this.x=x; this.y=y; this.size=24; this.collected=false; }
  draw(){ if(this.collected) return; ctx.beginPath(); ctx.fillStyle='#FFD700'; ctx.arc(this.x,this.y,this.size/2,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#B8860B'; ctx.stroke(); }
  checkCollect(player){
    if(this.collected) return;
    const half=this.size/2;
    if(player.x< this.x+half && player.x+player.width>this.x-half &&
       player.y< this.y+half && player.y+player.height>this.y-half){
      this.collected=true; score+=10;
      document.querySelector("#scoreboard").innerHTML="<span class='label'>SCORE</span>"+score;
    }
  }
}

/* Game */
function initGame(){
  player=new Player();
  platforms=[ new Platform(0, canvas.height-42, canvas.width, 42) ];
  player.y=platforms[0].y-player.height;
  keys={left:false,right:false}; scrollOffset=0; score=0; platformCount=0;
  gameRunning=true;
  document.querySelector("#scoreboard").innerHTML="<span class='label'>SCORE</span>0";
}
function generatePlatform(){
  const last=platforms[platforms.length-1];
  const gap=Math.random()*140+60, width=Math.random()*80+90, x=last.x+last.width+gap;
  let y=last.y+(Math.random()*240-120);
  if(y>canvas.height-120) y=canvas.height-120;
  if(y<250) y=250;
  platformCount++;
  let p;
  if(currentLevel===2 && platformCount%20===0) p=new MovingPlatform(x,y,width,28,'vertical');
  else if(currentLevel===3 && platformCount%40===0) p=new MovingPlatform(x,y,width,28,'horizontal');
  else if(currentLevel===3 && platformCount%20===0) p=new MovingPlatform(x,y,width,28,'vertical');
  else p=new Platform(x,y,width,28);
  if(Math.random()<0.75){const c=new Coin(x+width/2,y-18);p.coins.push(c);}
  platforms.push(p);
}
function gameLoop(){
  if(!gameRunning) return; ctx.clearRect(0,0,canvas.width,canvas.height);
  if(keys.right){scrollOffset+=player.speed;platforms.forEach(p=>{p.x-=player.speed;if(p.baseX)p.baseX-=player.speed;p.coins.forEach(c=>c.x-=player.speed);});}
  if(keys.left&&scrollOffset>0){scrollOffset-=player.speed;platforms.forEach(p=>{p.x+=player.speed;if(p.baseX)p.baseX+=player.speed;p.coins.forEach(c=>c.x+=player.speed);});}
  platforms=platforms.filter(p=>p.x+p.width>-200);
  while(platforms[platforms.length-1].x<canvas.width) generatePlatform();
  platforms.forEach(p=>p.draw());
  player.update(platforms);
  if(player.y>canvas.height+200) gameOver();
  if(score>=winningScore) winGame();
  if(gameRunning) requestAnimationFrame(gameLoop);
}

/* UI */
function gameOver(){gameRunning=false;saveHighScore();document.getElementById('gameOver').style.display='flex';}
function winGame(){gameRunning=false;saveHighScore();document.getElementById('winScreen').style.display='flex';document.getElementById('winMessage').innerText="Congrats! "+username;}
function saveHighScore(){ if(score>highScore){ highScore=score; localStorage.setItem("platformerHighScore",highScore); document.getElementById("highScoreBox").innerText="High Score: "+highScore; } }
function restartGame(){document.getElementById('gameOver').style.display='none';document.getElementById('winScreen').style.display='none';initGame();gameLoop();}
function goToMenu(){document.getElementById('gameOver').style.display='none';document.getElementById('winScreen').style.display='none';document.getElementById('mainMenu').style.display='flex';}

/* Start */
function startGame(level){username=document.getElementById('usernameInput').value||"Player";currentLevel=level;document.getElementById('mainMenu').style.display='none';initGame();gameLoop();}

/* Color carousel */
const carousel=document.getElementById('carousel');
playerColors.forEach(color=>{const d=document.createElement('div');d.className='circle';d.style.background=color;d.addEventListener('click',()=>selectColor(color,d));carousel.appendChild(d);});
function selectColor(color,el){selectedColor=color;document.querySelectorAll('.circle').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');}
selectColor(selectedColor,carousel.children[0]);

/* Controls */
window.addEventListener('keydown',e=>{if(e.code==='ArrowLeft')keys.left=true;if(e.code==='ArrowRight')keys.right=true;if((e.code==='Space'||e.code==='ArrowUp'||e.code==='KeyW')&&player.onGround){player.velocityY=player.jumpPower;}});
window.addEventListener('keyup',e=>{if(e.code==='ArrowLeft')keys.left=false;if(e.code==='ArrowRight')keys.right=false;});
</script>

</body>
</html>
